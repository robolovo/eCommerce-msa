# eCommerce-msa
A simple commerce application based on microservice architecture using Spring Cloud.

<br>

# Structure

![스크린샷 2022-03-20 오후 10 51 24](https://user-images.githubusercontent.com/55264231/159165701-05d45ea0-5409-4d57-9e92-62b01e2d6f9c.png)
<br>
(그림에 결제 서비스는 복잡한 관계로 나중에 구현해보기로 했다. 결제 API는 유저 서비스에 간단하게 구현해두었다.)

<br>

# Main Tasks

기존의 모놀리식 구조에서 하나의 서버에 모든 서비스들과 데이터베이스가 함께 구성되어 ACID 트랜잭션을 구현하기 쉬웠던 점과는 달리 마이크로서비스 구조에서는 여러 서비스가 다른 서버로 분리되어(분산 트랜잭션) 트랜잭션의 원자성을 구현하기가 쉽지 않다. (이를 폴리글랏(polyglot) 아키텍쳐라고도 하며, 각 비즈니스 특성에 맞게 언어와 데이터베이스를 사용할 수 있다는 점이 마이크로서비스 아키텍처의 장점이라고 할 수 있다.) 

분산 트랜잭션을 적절히 구현하는 것이 이번 실습의 가장 큰 난관이었고, 여러 아티클들을 보고 2PC와 SAGA Pattern이라는 방법이 있다는 것을 알아냈지만 너무 복잡해 보여 참고했던 내용들을 바탕으로 내 나름의 방식대로 구현해 보았다.

이 커머스 어플리케이션에 참여하는 모든 서비스들은 REST API를 통해 다른 서비스들과 통신을 한다. 트랜잭션의 연산들이 수행되는 도중에 어떤 연산이 실패하게 되면 그 연산 전에 수행되었던 모든 연산들을 rollback 해야 하는데, 이를 위해 비동기 메세지 큐인 카프카를 사용하였다.

<br>

![스크린샷 2022-03-25 오전 10 26 48](https://user-images.githubusercontent.com/55264231/160036748-6ce2e557-5cf4-4e37-8c4d-bcdcb23d0f72.png)

<br>

주문 도중에 결제 서비스에서 오류가 나게 되면 카프카를 통해 상품 서비스에게 알리고 이를 통해 차감되었던 상품의 재고 수량을 다시 이전 수량으로 되돌려 주어 결과적 일관성(eventual consistency)을 지키도록 해주었다.
